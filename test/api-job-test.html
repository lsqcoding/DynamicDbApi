<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API调用任务测试 - DynamicDb API</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .form-label {
            font-weight: 500;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .alert {
            margin-bottom: 1rem;
        }
        .api-config-panel {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fa fa-database mr-2"></i>DynamicDB API
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="fa fa-home mr-1"></i>首页</a></li>
                    <li class="nav-item"><a class="nav-link" href="db-connection.html"><i class="fa fa-plug mr-1"></i>数据库连接</a></li>
                    <li class="nav-item"><a class="nav-link" href="dynamic-query.html"><i class="fa fa-search mr-1"></i>动态查询</a></li>
                    <li class="nav-item"><a class="nav-link" href="scheduler.html"><i class="fa fa-clock-o mr-1"></i>定时任务</a></li>
                    <li class="nav-item"><a class="nav-link active" href="api-job-test.html"><i class="fa fa-link mr-1"></i>API任务测试</a></li>
                    <li class="nav-item"><a class="nav-link" href="validator.html"><i class="fa fa-check-circle mr-1"></i>功能验证</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="header">
        <div class="container text-center">
            <h1><i class="fa fa-link mr-2"></i>API调用任务测试</h1>
            <p class="lead">测试和创建调用自定义接口的定时任务</p>
        </div>
    </div>

    <div class="container mb-5">
        <!-- 消息提示区域 -->
        <div id="message-container" class="mb-4"></div>

        <div class="row">
            <!-- 任务创建表单 -->
            <div class="col-lg-8 offset-lg-2">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fa fa-plus-circle mr-2"></i>创建API调用任务</h5>
                    </div>
                    <div class="card-body">
                        <form id="create-api-job-form">
                            <div class="mb-3">
                                <label for="jobName" class="form-label">任务名称 *</label>
                                <input type="text" class="form-control" id="jobName" required placeholder="输入任务名称">
                            </div>
                            
                            <div class="mb-3">
                                <label for="jobDescription" class="form-label">任务描述（可选）</label>
                                <textarea class="form-control" id="jobDescription" rows="2" placeholder="输入任务描述"></textarea>
                                <small class="form-text text-muted">如果不填写，将根据API配置自动生成</small>
                            </div>

                            <div class="api-config-panel">
                                <h6 class="mb-3 text-primary"><i class="fa fa-cog mr-1"></i>API配置</h6>
                                
                                <div class="mb-3">
                                    <label for="apiUrl" class="form-label">API地址 *</label>
                                    <input type="text" class="form-control" id="apiUrl" required placeholder="/api/CustomQuery/ExecuteQuery">
                                    <small class="form-text text-muted">项目内的API接口地址，例如：/api/CustomQuery/ExecuteQuery</small>
                                </div>

                                <div class="mb-3">
                                    <label for="apiMethod" class="form-label">请求方法 *</label>
                                    <select class="form-select" id="apiMethod" required>
                                        <option value="GET">GET</option>
                                        <option value="POST">POST</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="apiBody" class="form-label">请求体（仅POST方法）</label>
                                    <textarea class="form-control" id="apiBody" rows="3" placeholder="{\"db\":\"default\",\"query\":\"SELECT COUNT(*) FROM Users\"}"></textarea>
                                    <small class="form-text text-muted">JSON格式的请求体数据</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="triggerType" class="form-label">触发器类型 *</label>
                                <select class="form-select" id="triggerType" required>
                                    <option value="Cron">Cron表达式</option>
                                    <option value="Simple">简单间隔（秒）</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="triggerExpression" class="form-label">触发器表达式 *</label>
                                <input type="text" class="form-control" id="triggerExpression" required placeholder="0 0 * * * ?">
                                <div id="cron-help" class="mt-2">
                                    <small class="form-text text-muted">
                                        Cron格式示例：<br>
                                        <code>0 0 * * * ?</code> - 每小时执行<br>
                                        <code>0 0 1 * * ?</code> - 每天凌晨1点执行<br>
                                        <code>*/30 * * * * ?</code> - 每30分钟执行<br>
                                        <code>0 0/5 * * * ?</code> - 每5小时执行
                                    </small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-check-label">
                                    <input type="checkbox" id="isEnabled" class="form-check-input" checked>
                                    启用任务
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fa fa-save mr-2"></i>创建API调用任务
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 示例和说明 -->
        <div class="card mt-5">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fa fa-book mr-2"></i>使用说明</h5>
            </div>
            <div class="card-body">
                <h6>支持的API接口</h6>
                <p>可以调用项目中的任何控制器接口，例如：</p>
                <ul>
                    <li><code>/api/CustomQuery/ExecuteQuery</code> - 执行自定义查询</li>
                    <li><code>/api/DynamicQuery/Query</code> - 执行动态查询</li>
                    <li>其他在Controllers目录下定义的API接口</li>
                </ul>

                <h6 class="mt-4">使用示例</h6>
                <div class="bg-light p-3 rounded mt-2">
                    <p><strong>1. 创建定时执行自定义查询的任务</strong></p>
                    <ul>
                        <li>任务名称：每日用户统计</li>
                        <li>API地址：/api/CustomQuery/ExecuteQuery</li>
                        <li>请求方法：POST</li>
                        <li>请求体：<code>{"db":"default","query":"SELECT COUNT(*) AS TotalUsers FROM Users"}</code></li>
                        <li>触发器表达式：0 0 1 * * ?（每天凌晨1点执行）</li>
                    </ul>
                </div>

                <div class="bg-light p-3 rounded mt-4">
                    <p><strong>2. 创建带自定义返回值的API调用任务</strong></p>
                    <ul>
                        <li>任务名称：带自定义返回值的用户查询</li>
                        <li>API地址：/api/CustomQuery/ExecuteQuery</li>
                        <li>请求方法：POST</li>
                        <li>请求体：<code>{"db":"default","query":"SELECT Id, UserName, Email FROM Users","returnType":"JsonArray"}</code></li>
                        <li>触发器表达式：*/30 * * * * ?（每30分钟执行）</li>
                    </ul>
                    <p class="mt-2"><strong>3. 创建带自定义对象返回值的API调用任务</strong></p>
                    <ul>
                        <li>任务名称：用户统计分析</li>
                        <li>API地址：/api/CustomQuery/ExecuteQuery</li>
                        <li>请求方法：POST</li>
                        <li>请求体：<code>{"db":"default","query":"SELECT COUNT(*) AS TotalUsers, MAX(CreatedAt) AS LastUserCreated FROM Users","returnType":"SingleObject"}</code></li>
                        <li>触发器表达式：0 0 */6 * * ?（每6小时执行）</li>
                    </ul>
                </div>

                <h6 class="mt-4">执行流程</h6>
                <ol>
                    <li>任务触发时，系统会创建HTTP请求到指定的API地址</li>
                    <li>请求会包含所有必要的身份验证信息</li>
                    <li>API接口执行完成后，结果会记录到任务执行状态中</li>
                    <li>可以通过任务管理接口查看执行结果和状态</li>
                </ol>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white py-4">
        <div class="container text-center">
            <p class="mb-0">© 2024 DynamicDB API</p>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // 显示消息
        function showMessage(type, message) {
            const container = document.getElementById('message-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                <strong>${type === 'success' ? '成功' : type === 'error' ? '错误' : '提示'}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alert);
            
            // 3秒后自动关闭
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    alert.remove();
                }, 300);
            }, 3000);
        }

        // 监听触发器类型变化
        document.getElementById('triggerType').addEventListener('change', function() {
            const cronHelp = document.getElementById('cron-help');
            if (this.value === 'Cron') {
                cronHelp.style.display = 'block';
                document.getElementById('triggerExpression').placeholder = '0 0 * * * ?';
            } else {
                cronHelp.style.display = 'none';
                document.getElementById('triggerExpression').placeholder = '300';
            }
        });

        // 创建API任务
        document.getElementById('create-api-job-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // 收集表单数据
                const formData = {
                    Name: document.getElementById('jobName').value,
                    Description: document.getElementById('jobDescription').value,
                    TriggerType: document.getElementById('triggerType').value,
                    TriggerExpression: document.getElementById('triggerExpression').value,
                    IsEnabled: document.getElementById('isEnabled').checked,
                    ApiConfig: {
                        ApiUrl: document.getElementById('apiUrl').value,
                        Method: document.getElementById('apiMethod').value,
                        Body: document.getElementById('apiBody').value ? JSON.parse(document.getElementById('apiBody').value) : null
                    }
                };

                // 显示加载状态
                const submitBtn = e.submitter;
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>创建中...';
                submitBtn.disabled = true;

                // 发送请求
                const response = await axios.post('/api/JobManagement/create-api-job', formData, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'test-token'}`
                    }
                });

                showMessage('success', `任务创建成功！任务ID: ${response.data.TaskId}`);
                
                // 重置表单
                e.target.reset();
            } catch (error) {
                showMessage('error', `创建任务失败: ${error.response?.data?.Message || error.message}`);
                console.error('创建任务失败:', error);
            } finally {
                // 恢复按钮状态
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 设置默认的触发器说明可见性
            document.getElementById('cron-help').style.display = 'block';
        });
    </script>
</body>
</html>